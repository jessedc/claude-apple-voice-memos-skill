#!/usr/bin/env python3
# SPDX-License-Identifier: 0BSD
"""Export Apple Voice Memos cloud recordings to CSV."""

import argparse
import csv
import os
import sqlite3
import sys
from datetime import datetime, timezone, timedelta

CORE_DATA_EPOCH = datetime(2001, 1, 1, tzinfo=timezone.utc)

QUERY = """
SELECT ZENCRYPTEDTITLE, ZDATE, ZDURATION, ZPATH
FROM ZCLOUDRECORDING
WHERE ZDATE >= ?
ORDER BY ZDATE DESC
"""


def format_duration(seconds):
    if seconds is None:
        return ""
    total = int(seconds)
    h, remainder = divmod(total, 3600)
    m, s = divmod(remainder, 60)
    if h > 0:
        return f"{h}:{m:02d}:{s:02d}"
    return f"{m}:{s:02d}"


def core_data_to_iso8601(timestamp):
    if timestamp is None:
        return ""
    dt = CORE_DATA_EPOCH + timedelta(seconds=timestamp)
    return dt.isoformat()


def main():
    parser = argparse.ArgumentParser(description="Export Voice Memos cloud recordings to CSV")
    parser.add_argument("database", help="Path to CloudRecordings.db")
    parser.add_argument("-o", "--output", default="-", help="Output CSV file (default: stdout)")
    parser.add_argument("-d", "--days", type=int, default=30, help="Number of days to look back (default: 30)")
    args = parser.parse_args()

    cutoff = datetime.now(timezone.utc) - timedelta(days=args.days)
    cutoff_core_data = (cutoff - CORE_DATA_EPOCH).total_seconds()

    db_path = os.path.expanduser(args.database)
    conn = sqlite3.connect(f"file:{db_path}?mode=ro", uri=True)
    rows = conn.execute(QUERY, (cutoff_core_data,)).fetchall()
    conn.close()

    out = open(args.output, "w", newline="") if args.output != "-" else sys.stdout
    writer = csv.writer(out)
    writer.writerow(["title", "date", "duration", "path"])
    for title, date, duration, path in rows:
        writer.writerow([title, core_data_to_iso8601(date), format_duration(duration), path])

    if out is not sys.stdout:
        out.close()


if __name__ == "__main__":
    main()
